##### 11. Понятие наихудшего времени выполнения программы (WCET). Факторы, влияющие на WCET. Фазы анализа WCET. Использование абстрактной интерпретации для выявления недопустимых путей. Анализ влияния конвейера на время выполнения программы.

Простейшая вычислительная задача:

- входные данные доступны в момент старта
- выходные данные готовы в момент завершения
- нет блокировок в процессе выполнения
- нет синхронизации или обмена данными в процессе выполнения
- время выполнения зависит только от: входных данных и состояния задачи в момент старта

**Наихудшее время выполнения программного кода (WCET)** 

– это максимальное время, которое требуется для выполнения данного фрагмента кода, в данном контексте (входные данные, состояние), на заданном аппаратном вычислителе. WCET используется в формуле оценки времени отклика задач для RM: $C_i$.

(есть еще BCET – Best-case execution time - нижняя оценка времени выполнения)

Цель анализа WCET – оценить сверху время выполнения фрагмента кода. Оценка должна быть:

- Безопасной (недопустимо ошибаться в меньшую сторону)
- Точной (завышенность приведёт к излишнему резервированию ресурсов системы)
- Затраты на ее анализ д.б. разумными

**WCET нельзя просто замерить, т.к.:**

- замер времени на ВСЕХ путях выполнения невозможен
- при определении тестовой выборки могут быть упущены редкие сценарии
- выбранные тестовые данные могут не породить самую длинную трассу
- внутреннее состояние процессора на момент старта измерений может НЕ БЫТЬ наихудшим

**Факторы, влияющие на WCET:**

- Возможные пути (последовательности действий) выполнения задачи, определяются:
  - Семантикой программного кода (спецификой реализации, в т.ч. аппаратно-зависимой семантикой)
  - Входными данными, возможными в данном контексте вызова программы
- Длительность выполнения каждого действия на каждом возможном пути выполнения, определяются
  - Аппаратной реализацией команд процессора
  - Состоянием аппаратных средств, влияющих на тайминги (кэш-память, конвейер и т.п.) (как связанные с самой задачей, так и связанные с внешними факторами (состояние на момент старта, вытеснение задачи))

 Длительность выполнения пути:

- В простом случае - длительность каждого действия константа.
- В реалистическом случае – длительности варьируются (конвейер, кэш-память, параллелизм процессора).

**Фазы анализа WCET:**

1. Анализ потоков: ограничить (сверху) число выполнений различных фрагментов программы (в основном, анализ программной составляющей) (даёт верхнюю оценку, которая корректна для всех возможных трасс)
    *Примеры предоставляемой информации*: ограничение на число итераций цикла, ограничение на глубину рекурсии, недопустимые пути выполнения.
    *Источники информации*: статический анализ программы и ручные аннотации кода.
2. Низкоуровневый анализ: ограничить (сверху) время выполнения различных фрагментов программы (сочетание анализа программной и аппаратной составляющих), большая часть исследований по WCET посвящена этой фазе.
   *Использует*: модель целевой аппаратуры (не требуется моделирование всех подробностей, при этом необходимо безопасно сверху оценить все задержки при работе аппаратуры)
   *Применяется:* к скомпанованому двоичному коду (исполняемой программе)
3. Вычисление: объединить результаты анализа потоков и низкоуровневого анализа, чтобы получить верхнюю оценку WCET
    *Примеры подходов*: расчёт по синтаксическому дереву (дерево обходится снизу-вверх), расчёт по путям выполнения, неявный перебор путей (IPET).

 

**Использование абстрактной интерпретации для выявления недопустимых путей** (фаза анализа – Анализ потоков)

*Анализируется граф потока управления, множество путей программного выполнения имеет вложенную структуру: все фактически возможные пути $\le$ статически допустимые (например, if(x<23){})  $\le$базовая ограниченность (например, число итераций цикла < 100)  $\le$структурно допустимые пути (бесконечно много); Требование базовой ограниченности: для каждого цикла должно быть известно (вычислено или задано) ограничение на число итераций. Недопустимые пути (например, найденные на основе if) исключаются из множества статически допустимых путей.*

<img src=".\img\11_0.PNG" alt="11_0" style="zoom: 25%;" />

**Абстрактная интерпретация (АИ):**

1. Ограничивает число итераций циклов и выявляет недопустимые пути
   - Вычисляет безопасную (расширенную) оценку множества значений каждой переменной для различных точек выполнения программы
   - В ходе АИ, переменной сопоставляется не конкретное значение, а множество значений («абстрактное» значение)
2. Программа «выполняется» с использованием абстрактных значений переменных
3. Результат выполнения: безопасная (расширенная) оценка множества допустимых путей выполнения
   - Все фактически допустимые пути входят в полученное множество
   - Также в него могут входить некоторые фактически НЕ допустимые пути
   - Пути, не вошедшие в полученное множество, гарантированно не допустимы

<img src=".\img\11_1.PNG" alt="11_1" style="zoom: 67%;" />

**Анализ влияния конвейера на время выполнения программы** (фаза анализа – Низкоуровневый анализ)
 Простой конвейер:
*Instruction fetch (выборка команды) -> instruction decode (декодирование команды) -> execution -> memory access (загрузить / сохранить значения в/из памяти) -> write back (запись результата)*

- В идеале: коэффициент ускорения равен числу ступеней конвейера
- Фактически: между командами есть зависимости по данным; «слом» конвейера при неверном предсказании ветвления; ожидание данных из памяти

Виды конвейеров: отсутствует / скалярный (один конвейер) / VLIW (несколько конвейеров, статическое планирование из загрузки на уровне компилятора) / Суперскалярный (несколько конвейеров, внеочередное выполнение команд (процессор может на ходу переставить порядок команд))

Чтобы учесть задержки в случае простого конвейера – в графе потока управления ребрам присваиваются отрицательные веса: 

<img src=".\img\11_2.PNG" alt="11_2" style="zoom: 25%;" />

 **Учет совместного влияния кэша и конвейера:**
 Анализ влияния конвейера должен брать на вход результаты анализа влияния кэш-памяти

- Команды помечаются попаданием/промахом в кэш
- Попадания/промахи влияют на задержки в конвейере